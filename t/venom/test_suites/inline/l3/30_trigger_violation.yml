name: Violation test
testcases:
- name: get_login_token
  steps:
  - type: get_login_token

- name: trigger_a_violation_on_the_node
  steps:
  - type: http
    method: PUT
    url: '{{.pfserver_webadmin_url}}/api/v1/node/02:06:19:98:00:00/apply_security_event'
    ignore_verify_ssl: true
    body: >-
     {
       "id": "02:06:19:98:00:00",
       "mac": "02:06:19:98:00:00",
       "security_event_id": "1300000"
     }
    headers:
      "Authorization": "{{.get_login_token.json.result.token}}"
      "Content-Type": "application/json"
    assertions:
      - result.statuscode ShouldEqual 200
    vars:
      vid:
        from: result.bodyjson.id

- name: test_if_the_device_is_in_the_isolation_ipset
  steps:
  - type: exec
    script: sleep 5

  - type: exec
    script: ipset test pfsession_Isol_192.168.1.0 192.168.1.10

- name: release_violation_on_the_node
  steps:
  - type: http
    method: PUT
    url: '{{.pfserver_webadmin_url}}/api/v1/node/02:06:19:98:00:00/close_security_event'
    ignore_verify_ssl: true
    body: >-
     {
       "security_event_id": "{{.trigger_a_violation_on_the_node.vid}}",
       "mac": "02:06:19:98:00:00"
     }
    headers:
      "Authorization": "{{.get_login_token.json.result.token}}"
      "Content-Type": "application/json"
    assertions:
      - result.statuscode ShouldEqual 200


- name: test_if_the_device_is_in_the_register_ipset
  steps:
  - type: exec
    script: sleep 5

  - type: exec
    script: ipset test pfsession_Reg_192.168.1.0 192.168.1.10

