name: Violation test
testcases:
- name: get_login_token
  steps:
  - type: get_login_token

- name: Trigger a violation on the node
  steps:
  - type: http
    method: PUT
    url: '{{.pfserver_webadmin_url}}/api/v1/node/02:06:19:98:00:00/apply_security_event'
    ignore_verify_ssl: true
    body: >-
     {
       "id": "02:06:19:98:00:00",
       "mac": "02:06:19:98:00:00",
       "security_event_id": "1200003"
     }
    headers:
      "Authorization": "{{.get_login_token.json.result.token}}"
      "Content-Type": "application/json"
    assertions:
      - result.statuscode ShouldEqual 200
    vars:
      vid:
        from: result.bodyjson.id

- name: Test if the device is in the Isolation ipset
  steps:
  - type: exec
    script: sleep 5

  - type: exec
    script: ipset test pfsession_Isol_192.168.1.0 192.168.1.10

- name: Release violation on the node
  steps:
  - type: http
    method: PUT
    url: '{{.pfserver_webadmin_url}}/api/v1/node/02:06:19:98:00:00/close_security_event'
    ignore_verify_ssl: true
    body: >-
     {
       "security_event_id": "{{.Trigger-a-violation-on-the-node.vid}}",
       "mac": "02:06:19:98:00:00"
     }
    headers:
      "Authorization": "{{.get_login_token.json.result.token}}"
      "Content-Type": "application/json"
    assertions:
      - result.statuscode ShouldEqual 200


- name: Test if the device is in the Register ipset
  steps:
  - type: exec
    script: sleep 5

  - type: exec
    script: ipset test pfsession_Reg_192.168.1.0 192.168.1.10

